<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>#BBD Sign â€¢ Crowd Vote</title>
    <style>
      :root {
        --pad: 16px;
        --radius: 16px;
        --shadow: 0 8px 24px rgba(0,0,0,.12);
        --accent: #1a88ff;
      }
      *{box-sizing:border-box}
      body{
        font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        margin:0;background:#0b0f14;color:#e8eef6;
      }
      header{padding:var(--pad);text-align:center}
      .card{
        background:#121922;margin:var(--pad);padding:var(--pad);
        border-radius:var(--radius);box-shadow:var(--shadow);
      }
      .label-row{display:flex;justify-content:space-between;align-items:center;gap:12px;font-size:14px;opacity:.9}
      .label-row .total{opacity:.8}

      /* Single stacked bar */
      .bar{
        display:flex;
        height:84px;
        margin-top:12px;
        margin-bottom: 36px;
        border-radius:14px;
        overflow:hidden;
        position:relative;
      }
      .chunk{
        position:relative;
        display:flex;align-items:center;justify-content:center;
        transition:flex 200ms ease, transform 160ms ease;
        min-width:1px;
      }
      .chunk .label{
        text-align:center;line-height:1.1;
        color:#000; /* no text-shadow; cleaner */
        font-weight:800;font-size:clamp(12px,2.4vw,16px);
        padding:0 4px;
        white-space:nowrap;
      }

      /* Top-3 count badge (added only to those bars in JS) */
      .badge-top{
        position:absolute;top:-22px;left:50%;transform:translateX(-50%);
        min-width:24px;height:22px;padding:0 8px;border-radius:999px;
        background:#0f1620;border:1px solid #2a3340;color:#cfe2ff;
        font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;
      }

.winner-crown{
  position:absolute;
  top:30%;
  left:50%;
  transform:translateX(-50%);
  font-size:26px;
  line-height:1;
  pointer-events:none;
}

      /* Swatch grid (2 rows Ã— 5 cols) */
      .grid{
        display:grid;grid-template-columns:repeat(5,56px);gap:14px;
        margin-top:20px;justify-content:center;
      }
      .sw{
        width:56px;height:56px;border:none;border-radius:14px;cursor:pointer;
        box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);
        transition:transform 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
      }
      .sw:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
      .sw:active{transform:translateY(0)}
      .sw[disabled]{opacity:.45;filter:grayscale(12%);cursor:not-allowed;transform:none!important;box-shadow:inset 0 0 0 1px rgba(0,0,0,.2)}

      .pill{padding:6px 10px;background:#0f1620;border:1px solid #2a3340;border-radius:999px;font-size:12px;opacity:.95}
      .pill b{color:var(--accent)}

      #toast{
        visibility:hidden;min-width:160px;background:var(--accent);color:#fff;text-align:center;border-radius:999px;
        padding:10px 16px;position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
      }
      #toast.show{visibility:visible;animation:fadein .2s, fadeout .2s 1.6s}
      @keyframes fadein{from{opacity:0;transform:translate(-50%,8px)}to{opacity:1;transform:translate(-50%,0)}}
      @keyframes fadeout{from{opacity:1}to{opacity:0;visibility:hidden}}

      
  .section-title {
    margin-top: 0;
    text-align: center;
    font-weight: 600;
    font-size: 15px;
    opacity: 0.95;
  }
    </style>
  </head>
  <body>
    <header>
      <h2>#BBD Sign â€¢ Crowd Vote</h2>
      <div class="pill">
        Vote every <b id="cooldownLabel">5s</b> â€¢ <span class="total">Total: <span id="totalVotes">0</span></span>
      </div>
    </header>

    <div class="card">
  <div class="section-title">Live votes:</div>
  <div id="bar" class="bar" aria-label="Vote distribution"></div>
  <div class="section-title">Tap to vote:</div>
  <div id="swatches" class="grid"></div>
</div>

    <div id="toast">Voted!</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA9L8ggCCiuZB0AEplEKlc7XYhzSOnwpRk",
        authDomain: "escape-signs.firebaseapp.com",
        databaseURL: "https://escape-signs-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "escape-signs",
        storageBucket: "escape-signs.firebasestorage.app",
        messagingSenderId: "182414223507",
        appId: "1:182414223507:web:141f861962ee2741478566",
        measurementId: "G-244TWGGCV0",
      };

      const ROOM="ESC1", ROOM_CODE="1234", COOLDOWN_MS=5000;
      const PALETTE=["#FF0000","#FF8400","#FFEA00","#00FF44","#00FFAE","#00D5FF","#0000FF","#9C7DFF","#FF33AA","#FFFFFF"];
      const LABELS=["Red","Orange","Yellow","Green","Cyan","Light-Blue","Dark-Blue","Purple","Pink","White"];

      // thresholds for inside labels
      const THRESH_PCT_FOR_PERCENT = 6;   // show "%"" when >= 6%
      const THRESH_PCT_FOR_COUNT   = 14;  // show "count â€¢ %"" when >= 14%

      const $=(s)=>document.querySelector(s);
      const bar=$("#bar"),sw=$("#swatches"),
            cooldownLabel=$("#cooldownLabel"),totalVotesEl=$("#totalVotes");

      const app=initializeApp(firebaseConfig);
      const db=getDatabase(app);
      const tallyRef=ref(db,`escape-signs/rooms/${ROOM}/tally`);
      const queueRef=ref(db,`escape-signs/rooms/${ROOM}/vote-queue`);

      // swatches (2Ã—5)
      const buttons=[];
      PALETTE.forEach((hex,i)=>{
        const b=document.createElement("button");
        b.className="sw";b.style.background=hex;b.title=LABELS[i];
        b.setAttribute("aria-label",`Vote ${LABELS[i]} ${hex}`);
        b.addEventListener("click",()=>vote(hex));
        sw.appendChild(b);buttons.push(b);
      });

      // cooldown
      let cooldownUntil=0,cooldownTimer=null;
      const setButtonsDisabled=(d)=>buttons.forEach(b=>b.disabled=d);
      function startCooldown(){cooldownUntil=Date.now()+COOLDOWN_MS;setButtonsDisabled(true);tickCooldown();
        if(cooldownTimer)clearInterval(cooldownTimer);
        cooldownTimer=setInterval(()=>{
          if(Date.now()>=cooldownUntil){clearInterval(cooldownTimer);cooldownTimer=null;setButtonsDisabled(false);cooldownLabel.textContent=`${COOLDOWN_MS/1000}s`;}
          else{tickCooldown();}
        },200);}
      function tickCooldown(){const ms=Math.max(0,cooldownUntil-Date.now());const s=Math.ceil(ms/1000);cooldownLabel.textContent=`${s}s`;}

      const session=localStorage.getItem("voteSession")||(crypto.randomUUID?crypto.randomUUID():String(Math.random()).slice(2));
      localStorage.setItem("voteSession",session);

      async function vote(hex){if(Date.now()<cooldownUntil) return;
        try{await push(queueRef,{hex,session,tsClient:Date.now(),code:ROOM_CODE});toast("Voted!");}
        catch(e){toast("Failed to vote");console.warn(e);}
        finally{startCooldown();}
      }

      function toast(m){const t=$("#toast");t.textContent=m||"Voted!";t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1800);}

     function renderBar(counts = {}, total = 0, leaderKey = null) {
  bar.innerHTML = "";

  // Determine leader if not provided
  let computedLeader = leaderKey;
  if (!computedLeader) {
    let best = -Infinity, bestKey = null;
    for (const [k, v] of Object.entries(counts)) {
      const n = Number(v) || 0;
      if (n > best) { best = n; bestKey = k; }
    }
    computedLeader = bestKey;
  }
  const leaderUpper = computedLeader ? String(computedLeader).replace("#","").toUpperCase() : null;

  PALETTE.forEach((hex) => {
    const k = hex.slice(1).toUpperCase();
    const c = Number(counts[k] || 0);

    const el = document.createElement("div");
    el.className = "chunk";
    el.style.background = hex;
    el.style.flex = String(c); // proportional to count
    el.title = `${hex} â€” ${c} vote${c === 1 ? "" : "s"}`;

    // Winner visuals: class + single floating crown
    if (leaderUpper && k === leaderUpper) {
      el.classList.add("winner");
      const crown = document.createElement("div");
      crown.className = "winner-crown";
      crown.textContent = "ðŸ‘‘";
      el.appendChild(crown);
    }

    // No inside labels or percentages; keep the bar clean
    bar.appendChild(el);
  });
}

      onValue(tallyRef,(snap)=>{
        const t=snap.val()||{};
        const counts=t.counts||{};
        const total=Number(t.total||0);
        const leader=t.leader||null;
        const leaderKey=leader?leader.replace("#","").toUpperCase():null;

        totalVotesEl.textContent=total;
        renderBar(counts,total,leaderKey);
      });
    </script>
  </body>
</html>
