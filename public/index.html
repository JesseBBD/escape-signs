<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>#BBD Sign • Crowd Vote</title>
    <style>
      :root {
        --pad: 16px;
        --radius: 16px;
        --shadow: 0 8px 24px rgba(0,0,0,.12);
        --accent: #1a88ff;
      }
      *{box-sizing:border-box}
      body{
        font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        margin:0;background:#0b0f14;color:#e8eef6;
      }
      header{padding:var(--pad);text-align:center}
      .card{
        background:#121922;margin:var(--pad);padding:var(--pad);
        border-radius:var(--radius);box-shadow:var(--shadow);
      }
      .label-row{display:flex;justify-content:space-between;align-items:center;gap:12px;font-size:14px;opacity:.9}
      .label-row .total{opacity:.8}

      /* Vote distribution bar */
      .bar{
        display:flex;gap:8px;align-items:flex-end;height:72px;margin-top:22px; /* extra top space for badges */
        overflow:visible; /* allow badges to float above */
      }
      .chunk{
        position:relative;border-radius:12px;min-width:36px;
        display:flex;align-items:center;justify-content:center;
        outline:2px solid transparent;transition:box-shadow 120ms ease, outline-color 120ms ease;
      }
      /* Count badge above each chunk */
      .badge-top{
        position:absolute;top:-18px;left:50%;transform:translateX(-50%);
        min-width:22px;height:22px;padding:0 8px;border-radius:999px;
        background:#0f1620;border:1px solid #2a3340;color:#cfe2ff;
        font-weight:800;font-size:12px;display:flex;align-items:center;justify-content:center;
        box-shadow:0 2px 6px rgba(0,0,0,.3);
        white-space:nowrap;
      }
      .chunk .label{
        display:grid;place-items:center;text-align:center;line-height:1.05;
        color:#000;mix-blend-mode:screen;text-shadow:0 1px 2px rgba(0,0,0,.35);
      }
      .chunk .count{display:none} /* count is moved to the badge now */
      .chunk .pct{font-weight:700;font-size:clamp(11px,2.4vw,14px);opacity:.95}

      /* Winner: ring + glow (no scale, no overlap) */
      .chunk.winner{
        outline-color:#fff;
        box-shadow:0 0 0 3px rgba(255,255,255,.28), 0 6px 18px rgba(0,0,0,.35);
      }

      /* Swatch grid (2 rows x 5 cols) */
      .grid{
        display:grid;grid-template-columns:repeat(5,48px);gap:12px;
        margin-top:14px;justify-content:center;
      }
      .sw{
        width:48px;height:48px;border:none;border-radius:12px;cursor:pointer;
        box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);
        transition:transform 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
      }
      .sw:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
      .sw:active{transform:translateY(0)}
      .sw[disabled]{opacity:.45;filter:grayscale(12%);cursor:not-allowed;transform:none!important;box-shadow:inset 0 0 0 1px rgba(0,0,0,.2)}

      .pill{padding:6px 10px;background:#0f1620;border:1px solid #2a3340;border-radius:999px;font-size:12px;opacity:.95}
      .pill b{color:var(--accent)}

      #toast{
        visibility:hidden;min-width:160px;background:var(--accent);color:#fff;text-align:center;border-radius:999px;
        padding:10px 16px;position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
      }
      #toast.show{visibility:visible;animation:fadein .2s, fadeout .2s 1.6s}
      @keyframes fadein{from{opacity:0;transform:translate(-50%,8px)}to{opacity:1;transform:translate(-50%,0)}}
      @keyframes fadeout{from{opacity:1}to{opacity:0;visibility:hidden}}

      /* Mobile tweaks */
      @media (max-width:560px){
        .bar{height:96px;gap:6px}
        .chunk{min-width:44px;border-radius:10px}
        .badge-top{top:-16px;height:20px;min-width:20px;font-size:11px}
        .grid{grid-template-columns:repeat(5,44px);gap:10px}
        .sw{width:44px;height:44px;border-radius:10px}
      }
      @media (max-width:380px){
        .grid{grid-template-columns:repeat(5,40px);gap:8px}
        .sw{width:40px;height:40px}
      }
    </style>
  </head>
  <body>
    <header>
      <h2>#BBD Sign • Crowd Vote</h2>
      <div class="pill">
        Room <span id="room">ESC1</span> • vote every <b id="cooldownLabel">5s</b> •
        Leader: <span id="leader">—</span> • <span class="total">Total: <span id="totalVotes">0</span></span>
      </div>
    </header>

    <div class="card">
      <div class="label-row">
        <div style="text-align:center">Live votes</div>
        <div class="pill" id="lastUpdated" aria-live="polite" style="display:none;"></div>
      </div>
      <div id="bar" class="bar" aria-label="Vote distribution"></div>
      <div style="margin-top:24px;text-align:center">Tap to vote:</div>
      <div id="swatches" class="grid"></div>
    </div>

    <div id="toast">Voted!</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyA9L8ggCCiuZB0AEplEKlc7XYhzSOnwpRk",
        authDomain: "escape-signs.firebaseapp.com",
        databaseURL: "https://escape-signs-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "escape-signs",
        storageBucket: "escape-signs.firebasestorage.app",
        messagingSenderId: "182414223507",
        appId: "1:182414223507:web:141f861962ee2741478566",
        measurementId: "G-244TWGGCV0",
      };

      const ROOM = "ESC1";
      const ROOM_CODE = "1234";
      const COOLDOWN_MS = 5000;
      const SHOW_UPDATED_PILL = false;

      const PALETTE = [
        "#FF0000","#FF8400","#FFEA00","#00FF44","#00FFAE",
        "#00D5FF","#0000FF","#9C7DFF","#FF33AA","#FFFFFF",
      ];
      const LABELS = [
        "Red","Orange","Yellow","Green","Cyan",
        "Light-Blue","Dark-Blue","Purple","Pink","White",
      ];

      // Elements
      const $ = (s)=>document.querySelector(s);
      $("#room").textContent = ROOM;
      const bar = $("#bar"), sw = $("#swatches"), leaderEl = $("#leader");
      const cooldownLabel = $("#cooldownLabel");
      const totalVotesEl = $("#totalVotes");
      const updatedEl = $("#lastUpdated");

      const toast = (m)=>{
        const t=$("#toast"); t.textContent=m||"Voted!"; t.classList.add("show");
        setTimeout(()=>t.classList.remove("show"),1800);
      };

      // Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const tallyRef = ref(db, `escape-signs/rooms/${ROOM}/tally`);
      const queueRef = ref(db, `escape-signs/rooms/${ROOM}/vote-queue`);

      // Build swatches (2 rows x 5)
      const buttons = [];
      PALETTE.forEach((hex, i)=>{
        const b = document.createElement("button");
        b.className = "sw";
        b.style.background = hex;
        b.title = LABELS[i];
        b.setAttribute("aria-label", `Vote ${LABELS[i]} ${hex}`);
        b.addEventListener("click", ()=>vote(hex));
        sw.appendChild(b);
        buttons.push(b);
      });

      // Cooldown state
      let cooldownUntil = 0, cooldownTimer = null;
      const setButtonsDisabled = (disabled)=>buttons.forEach((b)=>b.disabled=disabled);
      function startCooldown(){
        cooldownUntil = Date.now() + COOLDOWN_MS;
        setButtonsDisabled(true);
        tickCooldown();
        if (cooldownTimer) clearInterval(cooldownTimer);
        cooldownTimer = setInterval(()=>{
          if (Date.now() >= cooldownUntil){
            clearInterval(cooldownTimer); cooldownTimer = null;
            setButtonsDisabled(false);
            cooldownLabel.textContent = `${COOLDOWN_MS/1000}s`;
          } else { tickCooldown(); }
        }, 200);
      }
      function tickCooldown(){
        const ms = Math.max(0, cooldownUntil - Date.now());
        const secs = Math.ceil(ms/1000);
        cooldownLabel.textContent = `${secs}s`;
      }

      // Session id (per device)
      const session = localStorage.getItem("voteSession")
        || (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2));
      localStorage.setItem("voteSession", session);

      async function vote(hex){
        if (Date.now() < cooldownUntil) return;
        try{
          await push(queueRef, { hex, session, tsClient: Date.now(), code: ROOM_CODE });
          toast("Voted!");
        }catch(e){
          toast("Failed to vote"); console.warn(e);
        }finally{
          startCooldown();
        }
      }

      // Render bar with % label inside and count badge above
      function renderBar(counts={}, total=0, leaderKey=null){
        bar.innerHTML = "";

        // Compute leader if not provided
        let computedLeader = leaderKey;
        if (!computedLeader){
          let best = -Infinity, bestKey = null;
          for (const [k, v] of Object.entries(counts)){
            const n = Number(v) || 0;
            if (n > best){ best = n; bestKey = k; }
          }
          computedLeader = bestKey;
        }

        PALETTE.forEach((hex)=>{
          const k = hex.slice(1).toUpperCase();
          const c = Number(counts[k] || 0);
          const pct = total > 0 ? Math.round((c/total)*100) : 0;

          const el = document.createElement("div");
          el.className = "chunk";
          if (computedLeader && k === String(computedLeader).replace("#","").toUpperCase()){
            el.classList.add("winner");
          }
          el.style.background = hex;
          el.style.flex = String(Math.max(c, 0.5));
          el.title = `${hex} — ${c} vote${c===1?"":"s"} (${pct}%)`;

          // badge above (count)
          const badge = document.createElement("span");
          badge.className = "badge-top";
          badge.textContent = String(c);
          el.appendChild(badge);

          // % label inside the chunk
          const label = document.createElement("div");
          label.className = "label";
          label.innerHTML = `<div class="pct">${pct}%</div>`;
          el.appendChild(label);

          bar.appendChild(el);
        });
      }

      // Live updates from RTDB
      onValue(tallyRef,(snap)=>{
        const t = snap.val() || {};
        const counts = t.counts || {};
        const total = Number(t.total || 0);
        const leader = t.leader || null;
        const leaderKey = leader ? leader.replace("#","").toUpperCase() : null;

        totalVotesEl.textContent = total;
        if (SHOW_UPDATED_PILL){
          updatedEl.style.display = "inline-block";
          updatedEl.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
        }

        renderBar(counts, total, leaderKey);
        leaderEl.textContent = leader || "—";
      });
    </script>
  </body>
</html>
